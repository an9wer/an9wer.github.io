<!DOCTYPE html>
<html lang="en">
<head>
<title>an9wer's blog</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="docutils" />
<link rel="stylesheet" href="/statics/css/style.css" type="text/css" />
<link rel="stylesheet" href="/statics/css/icofont.css" type="text/css">
<link rel="alternate" type="application/rss+xml" title="Subscribe to an9wer's blog" href="/blog.rss" />
<link rel="icon" href="/statics/images/icon.jpg" type="image/jpeg" size="32x32" />
<body>
    <div id="main">

        <div id="header">
            <div id="headerLeft">
                <div id="name"><a href="/blog.html">an9wer's blog</a></div>
                <div id="signature">Just stick to it :)</div>
            </div> <!-- headerLeft -->
            <div id="headerRight">
                <div id="avatar"><img src="/statics/images/avatar.jpg"></div>
            </div> <!-- headerRight -->
        </div> <!-- header -->

        <div id="navbar">
            <a id="blog" class="current"
                href="/blog.html">Blog</a>
            <a id="moments"
                href="/moments.html">Moments</a>
            <a id="notes"
                href="/notes.html">Notes</a>
            <a id="tools"
                href="/tools.html">Tools</a>
        </div> <!-- navbar -->

        <div id="content">
<div class="section" id="v2ray-sniffing">
<h1>关于 v2ray sniffing</h1>
<p>v2ray 的 inbound 配置中有个 sniffing 参数，官方文档对它概念描述很模糊，目前只知
道开启后可以通过 outbound 来解析域名，但更具体的使用就不清楚了。</p>
<p>所以这里根据我实际使用之后的思考，得到的一些猜想和结论，记录下来，不求保证完全
正确。</p>
<p>当 inbound 是 socks5, http 之流的代理时，原始数据包会经过 TCP/IP 的层层协议发给
代理服务，也就是 v2ray，假设这里是 127.0.0.1:1080，v2ray 解开数据包后会得到目标
的域名，因为开启了 sniffing，所以 v2ray 会通过内部的路由规则将域名解析任务交给
某个 outbound 处理。</p>
<p>当 inbound 被设置成透明代理时（redirect 或者 tproxy），一般都是配合 iptables 规
则使用。原始数据包在到达 v2ray 时会先经过 iptables，但在这之前就已经把目标域名
给解析成 IP 了，否则怎么去匹配 iptables 的规则呢？大多数的程序都是调用 glibc 中
的 getaddrinfo, gethostbyname 函数来交给系统解析 IP 的。所以这个时候到达 v2ray
的都是 IP，sniffing 是否启用都不影响了，v2ray 不会帮我们解析域名。因此，我们需
要自己部署 dns resolver 来处理 dns 污染的问题。</p>
<div class="section" id="id1">
<h2>猜想关于程序何时会解析域名</h2>
<p>当一个程序没有使用 socks5, http 等代理时，其不会调用 getaddrinfo, gethostbyname
来解析域名，而是把数据包一股脑发给代理。只能说大部分程序是这样的，例如 Firefox
的代理配置中有个选项可以选择 socks5 代理之后是否同时代理 DNS 请求（Proxy DNS
when using SOCKS V5)，所以在 Firefox 中，即使使用了 socks5 代理，也可以不通过代
理来解析域名。</p>
<p>但一个程序使用的透明代理（也相当于没有使用代理），在其内部会调用 getaddrinfo,
gethostbyname 来解析域名。</p>
<p>Thanks for reading :)</p>
</div>
<div class="section" id="references">
<h2>References</h2>
<p><a class="reference external" href="https://zwischenzugs.com/2018/06/08/anatomy-of-a-linux-dns-lookup-part-i/">linux dns lookup</a></p>
</div>
</div>
        </div> <!-- content -->

        <div id="footer">
        <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA</a> 2018-2021 an9wer | powered by <a href="http://docutils.sourceforge.net/" target="_blank">docutils</a>
        </div> <!-- footer -->

    </div> <!-- main -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141786049-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-141786049-1');
    </script>

</body>
</html>
